name: ðŸ“š Scheduled Data to mdBook Page

on:
  schedule:
    - cron: '0 16 */2 * *' # Example: Runs every other day at 16:00 UTC
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for checkout and mdbook build/commit (optional, but safer)
      pages: write    # Required for the final deployment action
      id-token: write # Required for OIDC authentication
      
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        
      # --- Python Setup ---
      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 3. Install Dependencies
        run: pip install -r requirements.txt # Install crawler dependencies
        
      # --- Python Script Execution and Content Generation ---
      - name: 4. Execute Job Crawler & Generate Markdown ðŸ
        id: script_run
        run: |
          # The Python script runs and generates the new content file.
          # We'll assume the script is designed to output a file named 'src/latest_report.md'.
          python script/job_crawler.py
          
          # CRITICAL: Ensure the new page is linked in the book's table of contents
          REPORT_LINK='* [Latest Crawl Report](latest_report.md)'
          SUMMARY_FILE='src/SUMMARY.md'
          
          # Remove previous entry if it exists (using sed or similar for cross-platform)
          # Note: This sed command is for Linux/macOS. 
          # You might need a more robust approach if targeting Windows runners.
          sed -i '/Latest Crawl Report/d' $SUMMARY_FILE
          
          # Append the link to the end of the SUMMARY.md (before the last line or just append)
          echo $REPORT_LINK >> $SUMMARY_FILE

      # --- mdBook Build and Deployment ---
      - name: 5. Install and Build mdBook ðŸ“–
        # This action installs mdbook and runs 'mdbook build'
        uses: peaceiris/actions-mdbook@v2
        with:
          args: build # Compiles 'src/' into static HTML in the default './book' directory

      - name: 6. Configure Pages Artifact ðŸš€
        # Uploads the compiled HTML from the mdbook output directory
        uses: actions/upload-pages-artifact@v3
        with:
          path: './book' # This is the default output directory for mdbook

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build_and_deploy
    permissions:
      pages: write
      id-token: write
      
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
